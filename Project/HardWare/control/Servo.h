/*
 * =============================================================================
 * 这一层的职责非常“纯粹”：把上层的“速度/角度意图”转换成 PWM 脉宽（CCR）。
 *
 * ---------------------------------------------------------------------------
 * 1) 标准舵机 PWM 基础
 * ---------------------------------------------------------------------------
 * 常见舵机采用 50Hz PWM（周期约 20ms），脉宽通常在：
 *   500us ~ 2500us 之间变化
 * 对应角度范围取决于舵机类型：
 *   - 180°舵机：0~180 映射到 500~2500us
 *   - 270°舵机：0~270 映射到 500~2500us
 *
 * 线性映射公式（统一写法）：
 *   pulse = 500 + angle * (2000 / full_scale_deg)
 *
 * ---------------------------------------------------------------------------
 * 2) 360°连续旋转舵机（Continuous Servo）
 * ---------------------------------------------------------------------------
 * 连续旋转舵机不是“定位舵机”，而是“速度舵机”：
 *   - 1500us 附近：停止
 *   - 大于 1500us：一个方向转（速度随偏离增大）
 *   - 小于 1500us：反方向转
 *
 * ---------------------------------------------------------------------------
 * 3) Servo_Rotate_Angle_Timed 的原理（开环近似）
 * ---------------------------------------------------------------------------
 * 连续旋转舵机无法直接“转到某个角度”。
 * 本工程采用“假设转速恒定 + 计时停止”的开环方法：
 *   target_ms = angle / speed_deg_per_ms
 * 到点后 Timer.c 自动输出 STOP。
 *
 * 这属于“开环控制”，精度会受电压/负载影响。
 */

#ifndef __SERVO_H
#define __SERVO_H

#include "main.h"
#include "tim.h"
#include <stdint.h>

/* ================== 360°连续旋转舵机PWM定义 ==================
 * 说明：STOP=1500us（中位），偏离表示方向/速度
 * 这些常量要根据你的舵机实际调试校准（不同舵机中位可能略偏）
 */
#define SPEED_MAX_PROS      750     // 全速正转（示例）
#define SPEED_MAX_CONS      2250    // 全速反转（示例）
#define SPEED_CUT_PROS      1400    // 减速正转
#define SPEED_UP_CONS       1610    // 加速反转
#define STOP                1500    // 停止

void Servo_360mode(uint8_t Num, uint16_t mode);
void Servo_270Angle(uint8_t Num, float Angle);
void Servo_180Angle(uint8_t Num, float Angle);

/* 基于时间的连续旋转角度控制（支持抢占/打断） */
void Servo_Rotate_Angle_Timed(uint8_t Num, float Angle, uint16_t Pulse_Mode);
/* 取消360定时转动（抢占用） */
void Servo_Cancel_Timed(void);

#endif
